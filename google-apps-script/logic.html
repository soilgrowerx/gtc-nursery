<script>
/**
 * Application Logic for Tree Inventory App
 * Handles data processing, filtering, sorting, and business logic
 */

// Global app state
let appData = {
    trees: [],
    categories: [],
    priceRange: { min: 0, max: 200 },
    isLoaded: false
};

// Wishlist management functions
const WISHLIST_STORAGE_KEY = 'greentree-wishlist';

/**
 * Get wishlist from localStorage
 */
function getWishlist() {
    try {
        const stored = localStorage.getItem(WISHLIST_STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
    } catch (error) {
        console.warn('Failed to load wishlist from localStorage:', error);
        return [];
    }
}

/**
 * Save wishlist to localStorage
 */
function saveWishlist(wishlist) {
    try {
        localStorage.setItem(WISHLIST_STORAGE_KEY, JSON.stringify(wishlist));
        return true;
    } catch (error) {
        console.warn('Failed to save wishlist to localStorage:', error);
        return false;
    }
}

/**
 * Check if tree is in wishlist
 */
function isInWishlist(treeId) {
    const wishlist = getWishlist();
    return wishlist.includes(String(treeId));
}

/**
 * Add tree to wishlist
 */
function addToWishlist(treeId) {
    const wishlist = getWishlist();
    const treeIdStr = String(treeId);
    
    if (!wishlist.includes(treeIdStr)) {
        wishlist.push(treeIdStr);
        saveWishlist(wishlist);
        
        // Log action
        logUserAction('tree_favorited', { treeId: treeIdStr });
        
        return true;
    }
    return false;
}

/**
 * Remove tree from wishlist
 */
function removeFromWishlist(treeId) {
    const wishlist = getWishlist();
    const treeIdStr = String(treeId);
    const index = wishlist.indexOf(treeIdStr);
    
    if (index > -1) {
        wishlist.splice(index, 1);
        saveWishlist(wishlist);
        
        // Log action
        logUserAction('tree_unfavorited', { treeId: treeIdStr });
        
        return true;
    }
    return false;
}

/**
 * Toggle tree in wishlist
 */
function toggleWishlist(treeId) {
    const wasAdded = isInWishlist(treeId) ? 
        removeFromWishlist(treeId) : 
        addToWishlist(treeId);
    
    // Update UI to reflect change
    updateTreeCardWishlistButton(treeId);
    
    return wasAdded;
}

/**
 * Update a specific tree card's wishlist button
 */
function updateTreeCardWishlistButton(treeId) {
    const button = document.querySelector(`.wishlist-btn[data-tree-id="${treeId}"]`);
    if (!button) return;
    
    const isFavorited = isInWishlist(treeId);
    const heartIcon = isFavorited 
        ? '<span class="heart-icon favorited">‚ù§Ô∏è</span>'
        : '<span class="heart-icon">ü§ç</span>';
    
    button.innerHTML = heartIcon;
    button.title = isFavorited ? 'Remove from favorites' : 'Add to favorites';
}

/**
 * Get wishlist count
 */
function getWishlistCount() {
    return getWishlist().length;
}

/**
 * Clear entire wishlist
 */
function clearWishlist() {
    saveWishlist([]);
    logUserAction('wishlist_cleared');
    
    // Update all wishlist buttons
    document.querySelectorAll('.wishlist-btn').forEach(button => {
        const treeId = button.dataset.treeId;
        updateTreeCardWishlistButton(treeId);
    });
}

/**
 * Get mock inventory response for local testing
 */
function getMockInventoryResponse() {
    const mockTrees = [
        {
            "id": "43",
            "commonName": "Cypress, Bald",
            "botanicalName": "Taxodium distichum",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Taxodium%20distichum",
            "category": "Large Trees",
            "description": "Cypress, Bald (Taxodium distichum) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "CYP-BAL-043",
            "size": "1 Gallon",
            "price": 160,
            "quantityInStock": 6,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Cypress%2C%20Bald"
        },
        {
            "id": "44",
            "commonName": "Elm, American",
            "botanicalName": "Ulmus americana",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Ulmus%20americana",
            "category": "Large Trees",
            "description": "Elm, American (Ulmus americana) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "ELM-AME-044",
            "size": "1 Gallon",
            "price": 160,
            "quantityInStock": 0,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Elm%2C%20American"
        },
        {
            "id": "45",
            "commonName": "Elm, Cedar",
            "botanicalName": "Ulmus crassifolia",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Ulmus%20crassifolia",
            "category": "Large Trees",
            "description": "Elm, Cedar (Ulmus crassifolia) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "ELM-CED-045",
            "size": "1 Gallon",
            "price": 175,
            "quantityInStock": 9,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Elm%2C%20Cedar"
        },
        {
            "id": "46",
            "commonName": "Oak, Chinkapin",
            "botanicalName": "Quercus muehlenbergii",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20muehlenbergii",
            "category": "Large Trees",
            "description": "Oak, Chinkapin (Quercus muehlenbergii) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-CHI-046",
            "size": "1 Gallon",
            "price": 175,
            "quantityInStock": 1,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Chinkapin"
        },
        {
            "id": "47",
            "commonName": "Oak, Mexican White",
            "botanicalName": "Quercus polymorpha",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20polymorpha",
            "category": "Large Trees",
            "description": "Oak, Mexican White (Quercus polymorpha) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-MEX-WHI-047",
            "size": "1 Gallon",
            "price": 175,
            "quantityInStock": 10,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Mexican%20White"
        },
        {
            "id": "48",
            "commonName": "Pecan, Native",
            "botanicalName": "Carya illinoinensis",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Carya%20illinoinensis",
            "category": "Large Trees",
            "description": "Pecan, Native (Carya illinoinensis) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "PEC-NAT-048",
            "size": "1 Gallon",
            "price": 160,
            "quantityInStock": 4,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Pecan%2C%20Native"
        },
        {
            "id": "49",
            "commonName": "Redbud, Texas",
            "botanicalName": "Cercis canadensis var. texensis",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Cercis%20canadensis%20var.%20texensis",
            "category": "Large Trees",
            "description": "Redbud, Texas (Cercis canadensis var. texensis) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "RED-TEX-049",
            "size": "1 Gallon",
            "price": 175,
            "quantityInStock": 6,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Redbud%2C%20Texas"
        },
        {
            "id": "50",
            "commonName": "Willow, Desert 'Bubba'",
            "botanicalName": "Chilopsis linearis 'Bubba'",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Chilopsis%20linearis%20'Bubba'",
            "category": "Large Trees",
            "description": "Willow, Desert 'Bubba' (Chilopsis linearis 'Bubba') - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "WIL-DES-BUB-050",
            "size": "1 Gallon",
            "price": 175,
            "quantityInStock": 3,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Willow%2C%20Desert%20'Bubba'"
        },
        {
            "id": "1",
            "commonName": "Anacua",
            "botanicalName": "Ehretia anacua",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Ehretia%20anacua",
            "category": "Small Trees",
            "description": "Anacua (Ehretia anacua) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "ANA-001",
            "size": "1 Gallon - 1G/16-20\"",
            "price": 14,
            "quantityInStock": 4,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Anacua"
        },
        {
            "id": "2",
            "commonName": "Ash, Wafer (Common Hoptree)",
            "botanicalName": "Ptelea trifoliata",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Ptelea%20trifoliata",
            "category": "Small Trees",
            "description": "Ash, Wafer (Common Hoptree) (Ptelea trifoliata) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "ASH-WAF-COM-HOP-002",
            "size": "1 Gallon - 1G/6-10\"",
            "price": 16,
            "quantityInStock": 4,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Ash%2C%20Wafer%20(Common%20Hoptree)"
        },
        {
            "id": "3",
            "commonName": "Basswood, Carolina",
            "botanicalName": "Tilia americana",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Tilia%20americana",
            "category": "Small Trees",
            "description": "Basswood, Carolina (Tilia americana) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "BAS-CAR-003",
            "size": "3-5 Gallon - 5G/36\"",
            "price": 50,
            "quantityInStock": 1,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Basswood%2C%20Carolina"
        },
        {
            "id": "4",
            "commonName": "Buckeye, Red (R)",
            "botanicalName": "Aesculus pavia",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Aesculus%20pavia",
            "category": "Small Trees",
            "description": "Buckeye, Red (R) (Aesculus pavia) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "BUC-RED-R-004",
            "size": "1 Gallon - 1G/1",
            "price": 18,
            "quantityInStock": 2,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Buckeye%2C%20Red%20(R)"
        },
        {
            "id": "5",
            "commonName": "Buckthorn, Carolina",
            "botanicalName": "Rhamnus caroliniana",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Rhamnus%20caroliniana",
            "category": "Small Trees",
            "description": "Buckthorn, Carolina (Rhamnus caroliniana) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "BUC-CAR-005",
            "size": "1 Gallon - 1G/6-12\"",
            "price": 14,
            "quantityInStock": 16,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Buckthorn%2C%20Carolina"
        },
        {
            "id": "6",
            "commonName": "Bumilia, Gum",
            "botanicalName": "Sideroxylon lanuginosum",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Sideroxylon%20lanuginosum",
            "category": "Small Trees",
            "description": "Bumilia, Gum (Sideroxylon lanuginosum) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "BUM-GUM-006",
            "size": "1 Gallon",
            "price": 14,
            "quantityInStock": 10,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Bumilia%2C%20Gum"
        },
        {
            "id": "7",
            "commonName": "Cherry, Escarpment (R)",
            "botanicalName": "Prunus serotina var. eximia",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Prunus%20serotina%20var.%20eximia",
            "category": "Small Trees",
            "description": "Cherry, Escarpment (R) (Prunus serotina var. eximia) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "CHE-ESC-R-007",
            "size": "1 Gallon - 1G/1",
            "price": 20,
            "quantityInStock": 3,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Cherry%2C%20Escarpment%20(R)"
        },
        {
            "id": "9",
            "commonName": "Cottonwood, Eastern",
            "botanicalName": "Populus deltoides",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Populus%20deltoides",
            "category": "Small Trees",
            "description": "Cottonwood, Eastern (Populus deltoides) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "COT-EAS-009",
            "size": "1 Gallon",
            "price": 14,
            "quantityInStock": 1,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Cottonwood%2C%20Eastern"
        },
        {
            "id": "8",
            "commonName": "Cottonwood, Eastern #2",
            "botanicalName": "Populus deltoides",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Populus%20deltoides",
            "category": "Small Trees",
            "description": "Cottonwood, Eastern #2 (Populus deltoides) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "COT-EAS-2-008",
            "size": "1 Gallon - 2/4-20\"",
            "price": 10,
            "quantityInStock": 3,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Cottonwood%2C%20Eastern%20%232"
        },
        {
            "id": "10",
            "commonName": "Cypress, Arizona 'Carolina Sapphire'",
            "botanicalName": "Cupressus arizonica",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Cupressus%20arizonica",
            "category": "Small Trees",
            "description": "Cypress, Arizona 'Carolina Sapphire' (Cupressus arizonica) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "CYP-ARI-CAR-SAP-010",
            "size": "3-5 Gallon - 5G/30-36\"",
            "price": 50,
            "quantityInStock": 2,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Cypress%2C%20Arizona%20'Carolina%20Sapphire'"
        },
        {
            "id": "11",
            "commonName": "Cypress, Bald",
            "botanicalName": "Taxodium distichum",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Taxodium%20distichum",
            "category": "Small Trees",
            "description": "Cypress, Bald (Taxodium distichum) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "CYP-BAL-011",
            "size": "3-5 Gallon - 5G/4-5'",
            "price": 35,
            "quantityInStock": 4,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Cypress%2C%20Bald"
        },
        {
            "id": "12",
            "commonName": "Cypress, Montezuma",
            "botanicalName": "Taxodium mucronatum",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Taxodium%20mucronatum",
            "category": "Small Trees",
            "description": "Cypress, Montezuma (Taxodium mucronatum) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "CYP-MON-012",
            "size": "3-5 Gallon - 5G/4-5'",
            "price": 35,
            "quantityInStock": 5,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Cypress%2C%20Montezuma"
        },
        {
            "id": "13",
            "commonName": "Dogwood, Roughleaf",
            "botanicalName": "Cornus drummondii",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Cornus%20drummondii",
            "category": "Small Trees",
            "description": "Dogwood, Roughleaf (Cornus drummondii) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "DOG-ROU-013",
            "size": "1 Gallon - 1G/6-12\"",
            "price": 14,
            "quantityInStock": 4,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Dogwood%2C%20Roughleaf"
        },
        {
            "id": "14",
            "commonName": "Elder, Box",
            "botanicalName": "Acer negundo",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Acer%20negundo",
            "category": "Small Trees",
            "description": "Elder, Box (Acer negundo) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "ELD-BOX-014",
            "size": "1 Gallon - 1G/30\"",
            "price": 14,
            "quantityInStock": 3,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Elder%2C%20Box"
        },
        {
            "id": "15",
            "commonName": "Elm, American",
            "botanicalName": "Ulmus americana",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Ulmus%20americana",
            "category": "Small Trees",
            "description": "Elm, American (Ulmus americana) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "ELM-AME-015",
            "size": "1 Gallon - 1G/24-30\"",
            "price": 14,
            "quantityInStock": 6,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Elm%2C%20American"
        },
        {
            "id": "16",
            "commonName": "Elm, Cedar",
            "botanicalName": "Ulmus crassifolia",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Ulmus%20crassifolia",
            "category": "Small Trees",
            "description": "Elm, Cedar (Ulmus crassifolia) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "ELM-CED-016",
            "size": "1 Gallon - 1G/12-24\"",
            "price": 14,
            "quantityInStock": 40,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Elm%2C%20Cedar"
        },
        {
            "id": "17",
            "commonName": "Hackberry, Sugar",
            "botanicalName": "Celtis laevigata",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Celtis%20laevigata",
            "category": "Small Trees",
            "description": "Hackberry, Sugar (Celtis laevigata) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "HAC-SUG-017",
            "size": "1 Gallon - 1G/20-36\"",
            "price": 14,
            "quantityInStock": 6,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Hackberry%2C%20Sugar"
        },
        {
            "id": "18",
            "commonName": "Holly, Yaupon 'Pride of Houston'",
            "botanicalName": "Ilex vomitoria",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Ilex%20vomitoria",
            "category": "Small Trees",
            "description": "Holly, Yaupon 'Pride of Houston' (Ilex vomitoria) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "HOL-YAU-PRI-OF-HOU-018",
            "size": "3-5 Gallon - 5G/18-36\"",
            "price": 40,
            "quantityInStock": 10,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Holly%2C%20Yaupon%20'Pride%20of%20Houston'"
        },
        {
            "id": "19",
            "commonName": "Mulberry, Texas (seed grown) (R)",
            "botanicalName": "Morus microphylla",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Morus%20microphylla",
            "category": "Small Trees",
            "description": "Mulberry, Texas (seed grown) (R) (Morus microphylla) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "MUL-TEX-SEE-GRO-R-019",
            "size": "1 Gallon - 1G/2",
            "price": 14,
            "quantityInStock": 6,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Mulberry%2C%20Texas%20(seed%20grown)%20(R)"
        },
        {
            "id": "20",
            "commonName": "Necklace, Eve's",
            "botanicalName": "Styphnolobium affine",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Styphnolobium%20affine",
            "category": "Small Trees",
            "description": "Necklace, Eve's (Styphnolobium affine) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "NEC-EVE-020",
            "size": "1 Gallon",
            "price": 14,
            "quantityInStock": 12,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Necklace%2C%20Eve's"
        },
        {
            "id": "29",
            "commonName": "Oak (Hybrid)",
            "botanicalName": "Quercus rysophylla (hybrid)",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20rysophylla%20(hybrid)",
            "category": "Small Trees",
            "description": "Oak (Hybrid) (Quercus rysophylla (hybrid)) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-HYB-029",
            "size": "1 Gallon",
            "price": 20,
            "quantityInStock": 2,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%20(Hybrid)"
        },
        {
            "id": "28",
            "commonName": "Oak (Mexican Native)",
            "botanicalName": "Quercus rysophylla",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20rysophylla",
            "category": "Small Trees",
            "description": "Oak (Mexican Native) (Quercus rysophylla) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-MEX-NAT-028",
            "size": "1 Gallon - 1G/2",
            "price": 20,
            "quantityInStock": 4,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%20(Mexican%20Native)"
        },
        {
            "id": "21",
            "commonName": "Oak, Blackjack",
            "botanicalName": "Quercus marilandica",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20marilandica",
            "category": "Small Trees",
            "description": "Oak, Blackjack (Quercus marilandica) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-BLA-021",
            "size": "1 Gallon - 1G/2",
            "price": 16,
            "quantityInStock": 6,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Blackjack"
        },
        {
            "id": "22",
            "commonName": "Oak, Burr",
            "botanicalName": "Quercus macrocarpa",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20macrocarpa",
            "category": "Small Trees",
            "description": "Oak, Burr (Quercus macrocarpa) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-BUR-022",
            "size": "3-5 Gallon - 5G/4-5'",
            "price": 55,
            "quantityInStock": 10,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Burr"
        },
        {
            "id": "23",
            "commonName": "Oak, Canby",
            "botanicalName": "Quercus canbyi",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20canbyi",
            "category": "Small Trees",
            "description": "Oak, Canby (Quercus canbyi) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-CAN-023",
            "size": "3-5 Gallon - 5G/4-5'",
            "price": 45,
            "quantityInStock": 1,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Canby"
        },
        {
            "id": "24",
            "commonName": "Oak, Chinkapin",
            "botanicalName": "Quercus muehlenbergii",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20muehlenbergii",
            "category": "Small Trees",
            "description": "Oak, Chinkapin (Quercus muehlenbergii) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-CHI-024",
            "size": "3-5 Gallon - 5G/36-60\"",
            "price": 40,
            "quantityInStock": 8,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Chinkapin"
        },
        {
            "id": "25",
            "commonName": "Oak, Chinkapin (Kerr Co)",
            "botanicalName": "Quercus muehlenbergii",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20muehlenbergii",
            "category": "Small Trees",
            "description": "Oak, Chinkapin (Kerr Co) (Quercus muehlenbergii) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-CHI-KER-CO-025",
            "size": "1 Gallon - 1G/6-16\"",
            "price": 16,
            "quantityInStock": 5,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Chinkapin%20(Kerr%20Co)"
        },
        {
            "id": "26",
            "commonName": "Oak, Escarpment Live",
            "botanicalName": "Quercus fusiformis",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20fusiformis",
            "category": "Small Trees",
            "description": "Oak, Escarpment Live (Quercus fusiformis) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-ESC-LIV-026",
            "size": "1 Gallon - 1G/4-10\"",
            "price": 16,
            "quantityInStock": 20,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Escarpment%20Live"
        },
        {
            "id": "27",
            "commonName": "Oak, Lacey",
            "botanicalName": "Quercus laceyi",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20laceyi",
            "category": "Small Trees",
            "description": "Oak, Lacey (Quercus laceyi) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-LAC-027",
            "size": "3-5 Gallon - 5G/40-60\"",
            "price": 45,
            "quantityInStock": 5,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Lacey"
        },
        {
            "id": "30",
            "commonName": "Oak, Shumard Red",
            "botanicalName": "Quercus shumardii",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20shumardii",
            "category": "Small Trees",
            "description": "Oak, Shumard Red (Quercus shumardii) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-SHU-RED-030",
            "size": "1 Gallon",
            "price": 12,
            "quantityInStock": 20,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Shumard%20Red"
        },
        {
            "id": "31",
            "commonName": "Oak, Vasey",
            "botanicalName": "Quercus vaseyana",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Quercus%20vaseyana",
            "category": "Small Trees",
            "description": "Oak, Vasey (Quercus vaseyana) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OAK-VAS-031",
            "size": "1 Gallon - 1G/4-10\"",
            "price": 16,
            "quantityInStock": 20,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Oak%2C%20Vasey"
        },
        {
            "id": "32",
            "commonName": "Osage, Orange",
            "botanicalName": "Maclura pomifera",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Maclura%20pomifera",
            "category": "Small Trees",
            "description": "Osage, Orange (Maclura pomifera) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "OSA-ORA-032",
            "size": "1 Gallon - 1G/12-30\"",
            "price": 14,
            "quantityInStock": 29,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Osage%2C%20Orange"
        },
        {
            "id": "33",
            "commonName": "Persimmon, American",
            "botanicalName": "Diospyros virginiana",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Diospyros%20virginiana",
            "category": "Small Trees",
            "description": "Persimmon, American (Diospyros virginiana) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "PER-AME-033",
            "size": "3-5 Gallon - 5G/30-42\"",
            "price": 40,
            "quantityInStock": 6,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Persimmon%2C%20American"
        },
        {
            "id": "34",
            "commonName": "Redbud, Texas",
            "botanicalName": "Cercis canadensis var. texensis",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Cercis%20canadensis%20var.%20texensis",
            "category": "Small Trees",
            "description": "Redbud, Texas (Cercis canadensis var. texensis) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "RED-TEX-034",
            "size": "3-5 Gallon - 5G/3-5'",
            "price": 40,
            "quantityInStock": 4,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Redbud%2C%20Texas"
        },
        {
            "id": "35",
            "commonName": "Redbud, Texas (multi-stem)",
            "botanicalName": "Cercis canadensis var. texensis",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Cercis%20canadensis%20var.%20texensis",
            "category": "Small Trees",
            "description": "Redbud, Texas (multi-stem) (Cercis canadensis var. texensis) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "RED-TEX-MUL-035",
            "size": "3-5 Gallon - 5G/2-4'",
            "price": 35,
            "quantityInStock": 6,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Redbud%2C%20Texas%20(multi-stem)"
        },
        {
            "id": "36",
            "commonName": "Soapberry, Western",
            "botanicalName": "Sapindus saponaria var. drummondii",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Sapindus%20saponaria%20var.%20drummondii",
            "category": "Small Trees",
            "description": "Soapberry, Western (Sapindus saponaria var. drummondii) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "SOA-WES-036",
            "size": "1 Gallon - 1G/10-14\"",
            "price": 14,
            "quantityInStock": 8,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Soapberry%2C%20Western"
        },
        {
            "id": "37",
            "commonName": "Sycamore, American",
            "botanicalName": "Platanus occidentalis",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Platanus%20occidentalis",
            "category": "Small Trees",
            "description": "Sycamore, American (Platanus occidentalis) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "SYC-AME-037",
            "size": "1 Gallon - 1G/10-20\"",
            "price": 14,
            "quantityInStock": 16,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Sycamore%2C%20American"
        },
        {
            "id": "38",
            "commonName": "Sycamore, Arizona (AZ native)",
            "botanicalName": "Platanus wrightii",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Platanus%20wrightii",
            "category": "Small Trees",
            "description": "Sycamore, Arizona (AZ native) (Platanus wrightii) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "SYC-ARI-AZ-NAT-038",
            "size": "1 Gallon - 1G/24\"",
            "price": 14,
            "quantityInStock": 5,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Sycamore%2C%20Arizona%20(AZ%20native)"
        },
        {
            "id": "39",
            "commonName": "Walnut, Black",
            "botanicalName": "Juglans nigra",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Juglans%20nigra",
            "category": "Small Trees",
            "description": "Walnut, Black (Juglans nigra) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "WAL-BLA-039",
            "size": "1 Gallon - 1G/6-10\"",
            "price": 14,
            "quantityInStock": 1,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Walnut%2C%20Black"
        },
        {
            "id": "42",
            "commonName": "Willow, Black",
            "botanicalName": "Salix nigra",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Salix%20nigra",
            "category": "Small Trees",
            "description": "Willow, Black (Salix nigra) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "WIL-BLA-042",
            "size": "1 Gallon - 1G/24-36\"",
            "price": 14,
            "quantityInStock": 1,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Willow%2C%20Black"
        },
        {
            "id": "41",
            "commonName": "Willow, Desert 'Bubba'",
            "botanicalName": "Chilopsis linearis",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Chilopsis%20linearis",
            "category": "Small Trees",
            "description": "Willow, Desert 'Bubba' (Chilopsis linearis) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "WIL-DES-BUB-041",
            "size": "3-5 Gallon - 5G/36\"",
            "price": 40,
            "quantityInStock": 7,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Willow%2C%20Desert%20'Bubba'"
        },
        {
            "id": "40",
            "commonName": "Willow, Desert (Wild type)",
            "botanicalName": "Chilopsis linearis",
            "iNaturalistUrl": "https://www.inaturalist.org/search?q=Chilopsis%20linearis",
            "category": "Small Trees",
            "description": "Willow, Desert (Wild type) (Chilopsis linearis) - A native tree perfect for landscaping projects.",
            "plantingCareInfo": "Plant in appropriate soil conditions. Water regularly during establishment period. Follow proper planting depth guidelines.",
            "companionPlants": [],
            "complementaryTrees": [],
            "sku": "WIL-DES-WIL-TYP-040",
            "size": "1 Gallon - 1G/6-10\"",
            "price": 14,
            "quantityInStock": 10,
            "image": "https://via.placeholder.com/300x200/228B22/FFFFFF?text=Willow%2C%20Desert%20(Wild%20type)"
        }
    ];

    const categories = ["Small Trees", "Large Trees"];
    const priceRange = { min: 10, max: 175 };

    return {
        success: true,
        data: mockTrees,
        categories: categories,
        priceRange: priceRange
    };
}

/**
 * Main application initialization function
 */
function initializeApp() {
    console.log('Starting Tree Inventory Application...');
    
    // Initialize UI first
    if (typeof initializeUI === 'function') {
        console.log('Initializing UI...');
        initializeUI();
    } else {
        console.warn('initializeUI function not available');
    }
    
    // Load inventory data
    console.log('Loading inventory data...');
    loadInventoryData();
}

/**
 * Load inventory data from server or use mock data locally
 */
function loadInventoryData() {
    console.log('=== LOADING INVENTORY DATA STARTED ===');
    console.log('Loading inventory data...');
    console.log('UIManager available:', typeof UIManager !== 'undefined');
    console.log('UIManager.displayTrees available:', typeof UIManager?.displayTrees === 'function');
    
    // Check if UIManager is available before using it
    if (typeof UIManager !== 'undefined' && UIManager.showLoadingState) {
        UIManager.showLoadingState();
    }
    
    // Check if we're running locally (google.script is undefined)
    if (typeof google === 'undefined' || !google.script) {
        console.log('Running locally - using mock data');
        setTimeout(() => {
            handleInventoryLoaded(getMockInventoryResponse());
        }, 500); // Simulate network delay
    } else {
        // Call server-side function to get inventory
        google.script.run
            .withSuccessHandler(handleInventoryLoaded)
            .withFailureHandler(handleInventoryError)
            .getInventory();
    }
}

/**
 * Handle successful inventory data loading
 */
function handleInventoryLoaded(response) {
    console.log('=== INVENTORY DATA LOADED ===');
    console.log('Inventory data loaded successfully:', response);
    
    if (!response.success) {
        handleInventoryError(response.error);
        return;
    }
    
    // Store data in global state
    appData.trees = response.data;
    appData.categories = response.categories;
    appData.priceRange = response.priceRange;
    appData.isLoaded = true;
    
    // Update UI with loaded data
    if (typeof UIManager !== 'undefined') {
        if (UIManager.populateCategoryFilter) {
            UIManager.populateCategoryFilter(appData.categories);
        }
        if (UIManager.updatePriceRange) {
            UIManager.updatePriceRange(appData.priceRange);
        }
    }
    
    // Display all trees initially
    console.log('=== CALLING displayAllTrees ===');
    displayAllTrees();
    
    console.log(`Loaded ${appData.trees.length} trees in ${appData.categories.length} categories`);
}

/**
 * Handle inventory loading errors
 */
function handleInventoryError(error) {
    console.error('Failed to load inventory:', error);
    if (typeof UIManager !== 'undefined' && UIManager.handleError) {
        UIManager.handleError('Failed to load inventory data. Please refresh the page and try again.');
    } else {
        alert('Failed to load inventory data. Please refresh the page and try again.');
    }
}

/**
 * Display all trees (initial load)
 */
function displayAllTrees() {
    console.log('=== displayAllTrees CALLED ===');
    console.log('Number of trees to display:', appData.trees.length);
    const sortedTrees = sortTrees([...appData.trees], 'name', 'asc');
    console.log('=== CALLING UIManager.displayTrees ===');
    console.log('Sorted trees count:', sortedTrees.length);
    
    // Check if UIManager is available before using it
    if (typeof UIManager !== 'undefined' && UIManager.displayTrees) {
        UIManager.displayTrees(sortedTrees);
    } else {
        console.error('UIManager.displayTrees not available - trees cannot be displayed');
        // Fallback: try to display trees using the standalone displayTrees function
        if (typeof displayTrees === 'function') {
            console.log('Using fallback displayTrees function');
            displayTrees(sortedTrees);
        }
    }
    
    // Log initial load
    logUserAction('inventory_loaded', {
        totalTrees: appData.trees.length,
        categories: appData.categories.length
    });
}

/**
 * Filter and display trees based on current criteria
 */
function filterAndDisplayTrees(searchTerm, category, minPrice, maxPrice, availabilityFilter, sortBy, sortOrder) {
    console.log('Applying filters:', {
        searchTerm,
        category,
        minPrice,
        maxPrice,
        availabilityFilter,
        sortBy,
        sortOrder
    });
    
    if (!appData.isLoaded) {
        console.warn('Data not loaded yet, skipping filter');
        return;
    }
    
    // Apply filters
    let filteredTrees = filterTrees(
        appData.trees,
        searchTerm,
        category,
        minPrice,
        maxPrice,
        availabilityFilter
    );
    
    // Apply sorting
    filteredTrees = sortTrees(filteredTrees, sortBy, sortOrder);
    
    // Display results
    if (typeof UIManager !== 'undefined' && UIManager.displayTrees) {
        UIManager.displayTrees(filteredTrees);
    } else if (typeof displayTrees === 'function') {
        displayTrees(filteredTrees);
    }
    
    // Log filter action
    logUserAction('trees_filtered', {
        searchTerm,
        category,
        priceRange: [minPrice, maxPrice],
        availabilityFilter,
        sortBy,
        sortOrder,
        resultCount: filteredTrees.length
    });
}

/**
 * Filter trees based on criteria
 */
function filterTrees(trees, searchTerm, category, minPrice, maxPrice, availabilityFilter) {
    return trees.filter(tree => {
        // Search term filter - search across multiple fields
        const matchesSearch = !searchTerm || 
            tree.commonName.toLowerCase().includes(searchTerm.toLowerCase()) ||
            tree.botanicalName.toLowerCase().includes(searchTerm.toLowerCase()) ||
            tree.category.toLowerCase().includes(searchTerm.toLowerCase()) ||
            tree.sku.toLowerCase().includes(searchTerm.toLowerCase()) ||
            tree.description.toLowerCase().includes(searchTerm.toLowerCase());
        
        // Category filter
        const matchesCategory = !category || tree.category === category;
        
        // Price range filter  
        const matchesPrice = tree.price >= minPrice && tree.price <= maxPrice;
        
        // Availability filter
        const matchesAvailability = filterByAvailability(tree, availabilityFilter);
        
        return matchesSearch && matchesCategory && matchesPrice && matchesAvailability;
    });
}

/**
 * Filter trees by availability status
 */
function filterByAvailability(tree, availabilityFilter) {
    switch (availabilityFilter) {
        case 'inStock':
            return tree.quantityInStock > 5;
        case 'lowStock':
            return tree.quantityInStock > 0 && tree.quantityInStock <= 5;
        case 'outOfStock':
            return tree.quantityInStock === 0;
        case 'all':
        default:
            return true;
    }
}

/**
 * Sort trees based on criteria
 */
function sortTrees(trees, sortBy, sortOrder) {
    const sortedTrees = [...trees];
    
    sortedTrees.sort((a, b) => {
        let comparison = 0;
        
        switch (sortBy) {
            case 'name':
                comparison = a.commonName.localeCompare(b.commonName);
                break;
            case 'price':
                comparison = a.price - b.price;
                break;
            case 'stock':
                comparison = a.quantityInStock - b.quantityInStock;
                break;
            case 'category':
                comparison = a.category.localeCompare(b.category);
                // Secondary sort by name
                if (comparison === 0) {
                    comparison = a.commonName.localeCompare(b.commonName);
                }
                break;
            default:
                comparison = a.commonName.localeCompare(b.commonName);
        }
        
        return sortOrder === 'desc' ? -comparison : comparison;
    });
    
    return sortedTrees;
}

/**
 * Get tree statistics for dashboard/summary
 */
function getTreeStatistics() {
    if (!appData.isLoaded) {
        return null;
    }
    
    const stats = {
        total: appData.trees.length,
        inStock: appData.trees.filter(t => t.quantityInStock > 0).length,
        outOfStock: appData.trees.filter(t => t.quantityInStock === 0).length,
        lowStock: appData.trees.filter(t => t.quantityInStock > 0 && t.quantityInStock <= 5).length,
        categories: appData.categories.length,
        averagePrice: Math.round(appData.trees.reduce((sum, t) => sum + t.price, 0) / appData.trees.length),
        priceRange: appData.priceRange,
        totalValue: appData.trees.reduce((sum, t) => sum + (t.price * t.quantityInStock), 0),
        topCategories: getTopCategories(),
        recentlyUpdated: new Date().toLocaleDateString()
    };
    
    return stats;
}

/**
 * Get top categories by tree count
 */
function getTopCategories() {
    const categoryCounts = {};
    
    appData.trees.forEach(tree => {
        categoryCounts[tree.category] = (categoryCounts[tree.category] || 0) + 1;
    });
    
    return Object.entries(categoryCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 3)
        .map(([category, count]) => ({ category, count }));
}

/**
 * Search for trees with advanced criteria
 */
function performAdvancedSearch(criteria) {
    console.log('Performing advanced search:', criteria);
    
    if (!appData.isLoaded) {
        return [];
    }
    
    return appData.trees.filter(tree => {
        // All previous filters
        let matches = true;
        
        // Botanical name search
        if (criteria.botanicalName) {
            matches = matches && tree.botanicalName.toLowerCase().includes(criteria.botanicalName.toLowerCase());
        }
        
        // SKU search
        if (criteria.sku) {
            matches = matches && tree.sku.toLowerCase().includes(criteria.sku.toLowerCase());
        }
        
        // Size filter
        if (criteria.size) {
            matches = matches && tree.size.toLowerCase().includes(criteria.size.toLowerCase());
        }
        
        // Stock range
        if (criteria.minStock !== undefined) {
            matches = matches && tree.quantityInStock >= criteria.minStock;
        }
        if (criteria.maxStock !== undefined) {
            matches = matches && tree.quantityInStock <= criteria.maxStock;
        }
        
        return matches;
    });
}

/**
 * Export filtered trees to CSV format
 */
function exportToCSV(trees, filename) {
    if (!trees || trees.length === 0) {
        if (typeof UIManager !== 'undefined' && UIManager.handleError) {
            UIManager.handleError('No trees to export');
        } else {
            alert('No trees to export');
        }
        return;
    }
    
    const csvHeaders = [
        'Common Name',
        'Botanical Name',
        'Category',
        'Size',
        'Price',
        'Quantity in Stock',
        'SKU',
        'Availability Status'
    ];
    
    const csvRows = trees.map(tree => [
        tree.commonName,
        tree.botanicalName,
        tree.category,
        tree.size,
        tree.price,
        tree.quantityInStock,
        tree.sku,
        tree.quantityInStock > 0 ? 'In Stock' : 'Out of Stock'
    ]);
    
    const csvContent = [
        csvHeaders.join(','),
        ...csvRows.map(row => 
            row.map(cell => 
                typeof cell === 'string' && cell.includes(',') 
                    ? `"${cell.replace(/"/g, '""')}"` 
                    : cell
            ).join(',')
        )
    ].join('\n');
    
    // Create and download the CSV file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename || `tree_inventory_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Log export action
    logUserAction('inventory_exported', {
        format: 'csv',
        treeCount: trees.length,
        filename: filename
    });
}

/**
 * Get tree recommendations based on a tree ID
 */
function getTreeRecommendations(treeId, limit = 3) {
    const targetTree = appData.trees.find(t => t.id === treeId);
    if (!targetTree) return [];
    
    // Simple recommendation algorithm based on category and price similarity
    const recommendations = appData.trees
        .filter(tree => tree.id !== treeId && tree.quantityInStock > 0)
        .map(tree => {
            let score = 0;
            
            // Same category gets higher score
            if (tree.category === targetTree.category) {
                score += 50;
            }
            
            // Similar price range gets points
            const priceDiff = Math.abs(tree.price - targetTree.price);
            const maxPrice = Math.max(tree.price, targetTree.price);
            const priceSimiliarity = 1 - (priceDiff / maxPrice);
            score += priceSimiliarity * 30;
            
            // Size similarity
            if (tree.size === targetTree.size) {
                score += 20;
            }
            
            return { tree, score };
        })
        .sort((a, b) => b.score - a.score)
        .slice(0, limit)
        .map(item => item.tree);
    
    return recommendations;
}

/**
 * Validate tree data integrity
 */
function validateTreeData(trees) {
    const errors = [];
    
    trees.forEach((tree, index) => {
        if (!tree.id) errors.push(`Tree at index ${index} missing ID`);
        if (!tree.commonName) errors.push(`Tree ${tree.id} missing common name`);
        if (!tree.botanicalName) errors.push(`Tree ${tree.id} missing botanical name`);
        if (typeof tree.price !== 'number' || tree.price < 0) errors.push(`Tree ${tree.id} has invalid price`);
        if (typeof tree.quantityInStock !== 'number' || tree.quantityInStock < 0) errors.push(`Tree ${tree.id} has invalid stock quantity`);
        if (!tree.sku) errors.push(`Tree ${tree.id} missing SKU`);
        if (!tree.category) errors.push(`Tree ${tree.id} missing category`);
    });
    
    if (errors.length > 0) {
        console.warn('Tree data validation errors:', errors);
    }
    
    return errors;
}

/**
 * Log user actions for analytics
 */
function logUserAction(action, data) {
    const logData = {
        action,
        data,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        url: window.location.href
    };
    
    console.log('User action:', logData);
    
    // Send to server for logging (optional) - only in production
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
            .withFailureHandler((error) => console.warn('Failed to log action:', error))
            .logAction(action, data);
    }
}

/**
 * Handle application errors gracefully
 */
function handleAppError(error, context) {
    console.error(`Application error in ${context}:`, error);
    
    // Log error for debugging
    logUserAction('error_occurred', {
        error: error.toString(),
        context,
        stack: error.stack
    });
    
    // Show user-friendly error message
    if (typeof UIManager !== 'undefined' && UIManager.handleError) {
        UIManager.handleError(`An error occurred while ${context}. Please try again.`);
    } else {
        alert(`An error occurred while ${context}. Please try again.`);
    }
}

/**
 * Utility function to debounce API calls
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Format currency values consistently
 */
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

/**
 * Format date values consistently
 */
function formatDate(date) {
    return new Intl.DateTimeFormat('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }).format(new Date(date));
}

/**
 * Export filtered inventory data to CSV
 */
function exportFilteredInventory() {
    console.log('Exporting filtered inventory data...');
    
    // Show loading state
    if (typeof UIManager !== 'undefined' && UIManager.showLoadingState) {
        UIManager.showLoadingState();
    }
    
    // Check if we're running locally
    if (typeof google === 'undefined' || !google.script) {
        console.log('Running locally - using local export functionality');
        setTimeout(() => {
            handleLocalInventoryExport();
        }, 500);
    } else {
        // Get currently filtered tree IDs
        const filteredTreeIds = getCurrentlyFilteredTreeIds();
        
        // Call server-side export function
        google.script.run
            .withSuccessHandler(handleInventoryExportSuccess)
            .withFailureHandler(handleExportError)
            .exportInventoryData(filteredTreeIds);
    }
}

/**
 * Get currently filtered tree IDs
 */
function getCurrentlyFilteredTreeIds() {
    if (!appData.isLoaded) {
        return [];
    }
    
    // Apply current filters to get filtered trees
    const filteredTrees = filterTrees(
        appData.trees,
        currentFilters.search || '',
        currentFilters.category || '',
        currentFilters.minPrice || 0,
        currentFilters.maxPrice || 999,
        currentFilters.availability || 'all'
    );
    
    return filteredTrees.map(tree => tree.id);
}

/**
 * Handle successful inventory export
 */
function handleInventoryExportSuccess(response) {
    if (typeof UIManager !== 'undefined' && UIManager.hideLoadingState) {
        UIManager.hideLoadingState();
    }
    
    if (!response.success) {
        handleExportError(response.error);
        return;
    }
    
    // Generate filename with current date
    const today = new Date().toISOString().split('T')[0];
    const filename = `greentree-inventory-${today}.csv`;
    
    // Create and download CSV
    downloadCSV(response.data, filename);
    
    // Log export action
    logUserAction('inventory_exported', {
        treeCount: response.data.metadata.totalTrees,
        totalValue: response.data.metadata.totalValue,
        filename: filename
    });
    
    // Show success message
    showExportSuccessMessage('Inventory', response.data.metadata.totalTrees);
}

/**
 * Handle local inventory export
 */
function handleLocalInventoryExport() {
    // Get currently filtered trees
    let filteredTrees = appData.trees;
    
    // Apply current filters if available
    if (typeof currentFilters !== 'undefined') {
        filteredTrees = filterTrees(
            appData.trees,
            currentFilters.search || '',
            currentFilters.category || '',
            currentFilters.minPrice || 0,
            currentFilters.maxPrice || 999,
            currentFilters.availability || 'all'
        );
    }
    
    // Use existing exportToCSV function
    const today = new Date().toISOString().split('T')[0];
    const filename = `greentree-inventory-local-${today}.csv`;
    
    exportToCSV(filteredTrees, filename);
    
    if (typeof UIManager !== 'undefined' && UIManager.hideLoadingState) {
        UIManager.hideLoadingState();
    }
    
    // Show success message
    showExportSuccessMessage('Inventory', filteredTrees.length);
}

/**
 * Export client requests data to CSV
 */
function exportClientRequests(statusFilter = 'all') {
    console.log('Exporting client requests data...');
    
    // Show loading state
    if (typeof UIManager !== 'undefined' && UIManager.showLoadingState) {
        UIManager.showLoadingState();
    }
    
    // Check if we're running locally
    if (typeof google === 'undefined' || !google.script) {
        console.log('Running locally - client requests export not available in local mode');
        if (typeof UIManager !== 'undefined' && UIManager.hideLoadingState) {
            UIManager.hideLoadingState();
        }
        showExportErrorMessage('Client requests export is only available in production mode');
    } else {
        // Call server-side export function
        google.script.run
            .withSuccessHandler(handleClientRequestsExportSuccess)
            .withFailureHandler(handleExportError)
            .exportClientRequests(statusFilter);
    }
}

/**
 * Handle successful client requests export
 */
function handleClientRequestsExportSuccess(response) {
    if (typeof UIManager !== 'undefined' && UIManager.hideLoadingState) {
        UIManager.hideLoadingState();
    }
    
    if (!response.success) {
        handleExportError(response.error);
        return;
    }
    
    // Generate filename with current date
    const today = new Date().toISOString().split('T')[0];
    const filename = `greentree-client-requests-${today}.csv`;
    
    // Create and download CSV
    downloadCSV(response.data, filename);
    
    // Log export action
    logUserAction('client_requests_exported', {
        requestCount: response.data.metadata.totalRequests,
        totalValue: response.data.metadata.totalValue,
        filename: filename
    });
    
    // Show success message
    showExportSuccessMessage('Client Requests', response.data.metadata.totalRequests);
}

/**
 * Create and download CSV file
 */
function downloadCSV(data, filename) {
    try {
        // Create CSV content
        const csvContent = createCSVContent(data);
        
        // Create blob and download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up the URL object
        URL.revokeObjectURL(url);
        
        console.log(`CSV file ${filename} downloaded successfully`);
    } catch (error) {
        console.error('Error downloading CSV:', error);
        handleExportError(error.toString());
    }
}

/**
 * Create CSV content from data
 */
function createCSVContent(data) {
    const { headers, rows, metadata } = data;
    
    // Start with headers
    let csvContent = headers.map(header => `"${header}"`).join(',') + '\n';
    
    // Add data rows
    rows.forEach(row => {
        const csvRow = row.map(cell => {
            // Handle different data types
            if (cell === null || cell === undefined) {
                return '""';
            }
            // Convert to string and escape quotes
            const cellStr = String(cell).replace(/"/g, '""');
            return `"${cellStr}"`;
        }).join(',');
        csvContent += csvRow + '\n';
    });
    
    // Add metadata as comments at the end
    csvContent += '\n// Export Metadata\n';
    csvContent += `// Export Date: ${metadata.exportDate}\n`;
    if (metadata.totalTrees !== undefined) {
        csvContent += `// Total Trees: ${metadata.totalTrees}\n`;
        csvContent += `// Total Value: $${metadata.totalValue}\n`;
        csvContent += `// In Stock: ${metadata.inStockCount}\n`;
        csvContent += `// Out of Stock: ${metadata.outOfStockCount}\n`;
    }
    if (metadata.totalRequests !== undefined) {
        csvContent += `// Total Requests: ${metadata.totalRequests}\n`;
        csvContent += `// Total Value: $${metadata.totalValue}\n`;
        csvContent += `// Average Request Value: $${metadata.averageRequestValue}\n`;
    }
    
    return csvContent;
}

/**
 * Handle export errors
 */
function handleExportError(error) {
    console.error('Export error:', error);
    if (typeof UIManager !== 'undefined' && UIManager.hideLoadingState) {
        UIManager.hideLoadingState();
    }
    
    // Show user-friendly error message
    const errorMessage = typeof error === 'string' ? error : 'Failed to export data. Please try again.';
    showExportErrorMessage(errorMessage);
}

/**
 * Show export success message
 */
function showExportSuccessMessage(exportType, itemCount) {
    // Create a temporary success message
    const message = document.createElement('div');
    message.className = 'export-success-message';
    message.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4a7c1f;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-weight: 500;
        ">
            ‚úÖ ${exportType} exported successfully! (${itemCount} items)
        </div>
    `;
    
    document.body.appendChild(message);
    
    // Remove message after 3 seconds
    setTimeout(() => {
        if (message.parentNode) {
            message.parentNode.removeChild(message);
        }
    }, 3000);
}

/**
 * Show export error message
 */
function showExportErrorMessage(errorText) {
    // Create a temporary error message
    const message = document.createElement('div');
    message.className = 'export-error-message';
    message.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-weight: 500;
        ">
            ‚ùå Export failed: ${errorText}
        </div>
    `;
    
    document.body.appendChild(message);
    
    // Remove message after 5 seconds
    setTimeout(() => {
        if (message.parentNode) {
            message.parentNode.removeChild(message);
        }
    }, 5000);
}

/**
 * Get export statistics for current filters
 */
function getExportStatistics() {
    if (!appData.isLoaded) {
        return { totalTrees: 0, filteredTrees: 0 };
    }
    
    const filteredTrees = filterTrees(
        appData.trees,
        currentFilters.search || '',
        currentFilters.category || '',
        currentFilters.minPrice || 0,
        currentFilters.maxPrice || 999,
        currentFilters.availability || 'all'
    );
    
    return {
        totalTrees: appData.trees.length,
        filteredTrees: filteredTrees.length,
        totalValue: filteredTrees.reduce((sum, tree) => sum + (tree.price * tree.quantityInStock), 0)
    };
}

// Export main functions for global access
window.TreeInventory = {
    initializeApp,
    filterAndDisplayTrees,
    getTreeStatistics,
    performAdvancedSearch,
    exportToCSV,
    getTreeRecommendations,
    formatCurrency,
    formatDate,
    logUserAction,
    exportFilteredInventory,
    exportClientRequests,
    getExportStatistics
};

// Export wishlist functions for global access
window.WishlistManager = {
    getWishlist,
    addToWishlist,
    removeFromWishlist,
    toggleWishlist,
    isInWishlist,
    getWishlistCount,
    clearWishlist
};

// Expose functions globally for HTML onclick handlers
window.clearAllFilters = function() {
    if (typeof UIManager !== 'undefined' && UIManager.clearAllFilters) {
        UIManager.clearAllFilters();
    }
};

window.toggleWishlist = function(treeId) {
    return toggleWishlist(treeId);
};

window.isInWishlist = function(treeId) {
    return isInWishlist(treeId);
};

console.log('Tree Inventory Logic loaded successfully');
</script>